<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Teste de Integração do gmp Portal</title>
    <link rel="stylesheet" href="assets/css/gmp-portal.css">
    <style>
        .test-container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-result { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; margin-top: 10px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .success { color: #28a745; } .error { color: #dc3545; } .info { color: #17a2b8; } .warning { color: #ffc107; }
        button { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Teste de Integração do gmp Portal</h1>

        <div class="test-section">
            <h2>Verificação de status do sistema</h2>
            <button onclick="checkSystemStatus()">Verificar status do sistema</button>
            <div id="system-results" class="test-result"></div>
        </div>

        <div class="test-section">
            <h2>Teste de autenticação de usuário</h2>
            <button onclick="testUserAuth()">Testar autenticação (demo@gmp.com)</button>
            <button onclick="testUserRegistration()">Testar registro de usuário</button>
            <button onclick="testPasswordReset()">Testar redefinição de senha (placeholder)</button>
            <div id="auth-results" class="test-result"></div>
        </div>

        <div class="test-section">
            <h2>Teste de controle de acesso a dados</h2>
            <button onclick="testDataAccess()">Testar controle de acesso (dashboard)</button>
            <button onclick="testRoleBasedAccess()">Testar acesso baseado em papéis</button>
            <button onclick="testAuditLogs()">Testar log de auditoria (placeholder)</button>
            <div id="access-results" class="test-result"></div>
        </div>

        <div class="test-section">
            <h2>Teste de integração Oracle</h2>
            <button onclick="testOracleIntegration()">Testar integração Oracle (placeholder)</button>
            <button onclick="testDataSync()">Testar sincronização de dados (placeholder)</button>
            <button onclick="testCrossDBQuery()">Testar consulta entre bancos (placeholder)</button>
            <div id="oracle-results" class="test-result"></div>
        </div>

        <div class="test-section">
            <h2>Teste completo de integração</h2>
            <button onclick="runFullIntegrationTest()">Executar teste completo de integração</button>
            <div id="full-results" class="test-result"></div>
        </div>
    </div>

    <script>
        let testResults = { system: [], auth: [], access: [], oracle: [], full: [] };

        function logResult(category, message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            testResults[category].push(logEntry);
            const container = document.getElementById(category + '-results');
            if (container) {
                container.innerText = testResults[category].join('\n');
                container.scrollTop = container.scrollHeight;
            }
        }

        // Status do sistema (dados reais do navegador + validação backend)
        async function checkSystemStatus() {
            try {
                logResult('system', 'Iniciando verificação de status...', 'info');
                const browser = navigator.userAgent;
                const storage = typeof(Storage) !== 'undefined';
                logResult('system', `Navegador: ${browser}`, 'info');
                logResult('system', `Suporte a storage: ${storage}`, 'info');

                // Valida token no backend
                const res = await fetch('/api/security/validate', { headers: securityManager.getAuthHeaders() });
                const data = await res.json();
                if (res.ok && data.valid) {
                    logResult('system', 'Backend acessível e token válido', 'success');
                } else {
                    logResult('system', 'Token ausente ou inválido', 'warning');
                }
            } catch (error) {
                logResult('system', `Falha na verificação: ${error.message}`, 'error');
            }
        }

        // Autenticação real
        async function testUserAuth() {
            try {
                logResult('auth', 'Autenticando demo@gmp.com...', 'info');
                const result = await securityManager.login('demo@gmp.com', 'password');
                if (result.success) {
                    logResult('auth', `Login OK: ${JSON.stringify(result.user)}`, 'success');
                } else {
                    logResult('auth', `Falha: ${result.error}`, 'error');
                }
            } catch (error) {
                logResult('auth', `Erro: ${error.message}`, 'error');
            }
        }

        async function testUserRegistration() {
            try {
                logResult('auth', 'Registrando novo usuário...', 'info');
                const unique = Date.now();
                const result = await securityManager.register('New User', `new${unique}@mail.com`, 'Password123!');
                logResult('auth', `Registro: ${JSON.stringify(result)}`, result.success ? 'success' : 'error');
            } catch (error) {
                logResult('auth', `Erro: ${error.message}`, 'error');
            }
        }

        function testPasswordReset() {
            logResult('auth', 'Placeholder: implementar fluxo real de reset no backend', 'warning');
        }

        // Acesso a dados (dashboard real)
        async function testDataAccess() {
            try {
                logResult('access', 'Carregando dashboard...', 'info');
                const res = await fetch('/api/dashboard', { headers: securityManager.getAuthHeaders() });
                const data = await res.json();
                if (res.ok) {
                    logResult('access', `Dashboard: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    logResult('access', `Erro: ${data.error || 'Falha ao carregar'}`, 'error');
                }
            } catch (error) {
                logResult('access', `Erro: ${error.message}`, 'error');
            }
        }

        function testRoleBasedAccess() {
            const user = securityManager.currentUser;
            if (!user) {
                logResult('access', 'Usuário não autenticado', 'warning');
                return;
            }
            logResult('access', `Role atual: ${user.role}`, 'info');
            if (user.role === 'ADMIN') {
                logResult('access', 'Acesso admin concedido', 'success');
            } else {
                logResult('access', 'Acesso admin negado para role atual', 'warning');
            }
        }

        function testAuditLogs() {
            logResult('access', 'Placeholder: implementar logs de auditoria no backend', 'warning');
        }

        // Oracle placeholders
        function testOracleIntegration() { logResult('oracle', 'Placeholder Oracle: configure driver e endpoints reais', 'warning'); }
        function testDataSync() { logResult('oracle', 'Placeholder Sync: implementar rotina real de sincronização', 'warning'); }
        function testCrossDBQuery() { logResult('oracle', 'Placeholder Cross-DB: implementar consulta real entre bancos', 'warning'); }

        // Teste completo
        async function runFullIntegrationTest() {
            try {
                logResult('full', 'Iniciando teste completo...', 'info');
                await checkSystemStatus();
                await testUserAuth();
                await testUserRegistration();
                testPasswordReset();
                await testDataAccess();
                testRoleBasedAccess();
                testAuditLogs();
                testOracleIntegration();
                testDataSync();
                testCrossDBQuery();
                logResult('full', 'Teste completo concluído', 'success');
            } catch (error) {
                logResult('full', `Falha: ${error.message}`, 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            logResult('system', 'Página de teste de integração carregada', 'info');
            logResult('auth', 'Teste de autenticação pronto', 'info');
            logResult('access', 'Teste de acesso a dados pronto', 'info');
            logResult('oracle', 'Teste de integração Oracle pronto', 'info');
            logResult('full', 'Teste completo de integração pronto', 'info');
        });
    </script>
    <script src="assets/js/security.js"></script>
</body>
</html>
