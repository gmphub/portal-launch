<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Analytics - gmp Academy Admin</title>
  <link href="../assets/css/main.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header id="header">
    <div class="d-flex align-items-center">
      <button aria-label="Toggle menu" id="menuToggle">
        <i class="fas fa-bars"></i>
      </button>
      <nav class="breadcrumb">
        <div class="breadcrumb-item">
          <a href="index.html">Admin</a>
        </div>
        <div class="breadcrumb-item active">
          <span>Analytics</span>
        </div>
      </nav>
    </div>
    <div class="d-flex align-items-center gap-2">
      <button aria-label="Toggle theme" class="theme-toggle" id="themeToggle">
        <i class="fas fa-moon" id="themeIcon"></i>
      </button>
      <div class="user-menu">
        <div class="user-avatar" id="gmIcon">GM</div>
        <div class="gm-dropdown">
          <a href="../student/profile.html">Perfil</a>
          <a href="settings.html">Configurações</a>
          <a href="../login.html">Sair</a>
        </div>
      </div>
    </div>
  </header>

  <div class="wrapper">
    <div class="sidebar" id="sidebar">
      <div class="logo">
        <img alt="gmp Academy Logo" class="logo-img" src="../assets/images/Logo gmp Academy Round 2025.png"/>
        <span class="logo-text">gmp Academy</span>
      </div>
      <nav class="sidebar-nav">
        <a class="nav-item" href="index.html"><i class="fas fa-home"></i> Início</a>
        <a class="nav-item" href="products.html"><i class="fas fa-box"></i> Produtos</a>
        <a class="nav-item has-submenu" href="#"><i class="fas fa-edit"></i> Gerenciar Conteúdo <i class="fas fa-chevron-down nav-arrow"></i></a>
        <ul class="submenu">
          <li><a class="sub-item" href="content-manager.html"><i class="fas fa-eye"></i> Visão Geral</a></li>
          <li><a class="sub-item" href="video-upload.html"><i class="fas fa-video"></i> Upload de Vídeos</a></li>
          <li><a class="sub-item" href="bulk-upload.html"><i class="fas fa-upload"></i> Upload em Lote</a></li>
          <li><a class="sub-item" href="media-library.html"><i class="fas fa-photo-video"></i> Biblioteca de Mídia</a></li>
        </ul>
        <a class="nav-item" href="students.html"><i class="fas fa-users"></i> Alunos</a>
        <a class="nav-item" href="classes.html"><i class="fas fa-chalkboard-teacher"></i> Turmas</a>
        <a class="nav-item active" href="analytics.html"><i class="fas fa-chart-bar"></i> Analytics</a>
        <a class="nav-item" href="certificates.html"><i class="fas fa-certificate"></i> Certificados</a>
        <a class="nav-item" href="gamification.html"><i class="fas fa-trophy"></i> Gamificação</a>
        <a class="nav-item" href="sales.html"><i class="fas fa-dollar-sign"></i> Vendas</a>
        <a class="nav-item" href="comments.html"><i class="fas fa-comments"></i> Comentários</a>
        <a class="nav-item" href="showcase.html"><i class="fas fa-store"></i> Vitrine</a>
        <a class="nav-item has-submenu" href="#"><i class="fas fa-cog"></i> Configurações <i class="fas fa-chevron-down nav-arrow"></i></a>
        <ul class="submenu">
          <li><a class="sub-item" href="settings.html"><i class="fas fa-cogs"></i> Geral</a></li>
          <li><a class="sub-item" href="personalization.html"><i class="fas fa-palette"></i> Personalização</a></li>
          <li><a class="sub-item" href="payment-setup.html"><i class="fas fa-credit-card"></i> Config. Pagamento</a></li>
          <li><a class="sub-item" href="payment-history.html"><i class="fas fa-history"></i> Histórico Pagamento</a></li>
        </ul>
      </nav>
    </div>

    <main class="main-content" id="mainContent">
      <div class="container full-width">
        <div class="container" style="padding: 2rem;">
          <div class="card">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <h1 style="margin-bottom: 0.5rem;">Analytics</h1>
                  <p style="color: var(--text-secondary); margin: 0;">
                    Acompanhe o desempenho do seu curso e engajamento dos alunos
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="metrics-grid" id="metricsGrid">
            <!-- Métricas dinâmicas -->
          </div>

          <div class="card">
            <div class="card-header">
              <h3>Engajamento por Curso</h3>
            </div>
            <div class="card-body">
              <canvas id="engagementChart" height="200"></canvas>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3>Progresso (%) por Curso</h3>
            </div>
            <div class="card-body">
              <canvas id="progressChart" height="200"></canvas>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="../assets/js/security.js"></script>
  <script src="../assets/js/main.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const session = GMP_Security.getSession();
      if (!session || session.user.role !== 'ADMIN') {
        window.location.href = '/gmp-portal/access-denied.html';
        return;
      }

      try {
        const res = await fetch('/api/dashboard', {
          headers: GMP_Security.getAuthHeaders()
        });
        const data = await res.json();
        if (!data.user) throw new Error('Usuário não autenticado');

        const progress = data.progress || [];
        const metrics = {
          alunosAtivos: 1,
          aulasAssistidas: progress.reduce((sum, p) => sum + (p.lessonsCompleted || 0), 0),
          tempoTotal: progress.reduce((sum, p) => sum + (p.duration || 0), 0),
          taxaConclusao: progress.length > 0
            ? Math.round((progress.filter(p => p.progressPercentage >= 100).length / progress.length) * 100)
            : 0
        };

        renderMetrics(metrics);
        renderCharts(progress);
      } catch (error) {
        console.error('Erro ao carregar analytics:', error);
        alert('Erro ao carregar dados analíticos.');
      }
    });

    function renderMetrics(metrics) {
      const grid = document.getElementById('metricsGrid');
      grid.innerHTML = `
        <div class="metric-card">
          <div class="metric-value">${metrics.alunosAtivos}</div>
          <div class="metric-label">Alunos Ativos</div>
        </div>
        <div class="metric-card">
          <div class="metric-value">${metrics.aulasAssistidas}</div>
          <div class="metric-label">Aulas Assistidas</div>
        </div>
        <div class="metric-card">
          <div class="metric-value">${formatTime(metrics.tempoTotal)}</div>
          <div class="metric-label">Tempo Total de Estudo</div>
        </div>
        <div class="metric-card">
          <div class="metric-value">${metrics.taxaConclusao}%</div>
          <div class="metric-label">Taxa de Conclusão</div>
        </div>
      `;
    }

    function formatTime(mins) {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return `${h}h ${m}m`;
    }

    function renderCharts(progress) {
        const labels = progress.map(p => p.title || p.courseId);
        const engagementValues = progress.map(p => p.lessonsCompleted || 0);
        const progressValues = progress.map(p => Math.round(p.progressPercentage || 0));

        new Chart(document.getElementById('engagementChart'), {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'Aulas Assistidas',
                    data: engagementValues,
                    backgroundColor: '#007bff'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        new Chart(document.getElementById('progressChart'), {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'Progresso (%)',
                    data: progressValues,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40,167,69,0.1)',
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }
  </script>
</body>
</html>
