<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Testes - gmp Portal</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; background: #f5f5f5; }
    h1 { color: #333; }
    .tabs { display: flex; margin-bottom: 1rem; }
    .tab { padding: 0.5rem 1rem; cursor: pointer; background: #ddd; margin-right: 0.5rem; border-radius: 5px 5px 0 0; }
    .tab.active { background: #fff; border-bottom: 2px solid #fff; font-weight: bold; }
    .section { display: none; padding: 1rem; background: #fff; border-radius: 0 5px 5px 5px; }
    .section.active { display: block; }
    button { margin: 0.25rem; padding: 0.5rem 1rem; }
    pre { background: #222; color: #0f0; padding: 1rem; border-radius: 8px; max-height: 300px; overflow: auto; }
  </style>
</head>
<body>
  <h1>Testes de Rotas - gmp Portal</h1>

  <div class="tabs">
    <div class="tab active" onclick="showTab('student')">Student</div>
    <div class="tab" onclick="showTab('admin')">Admin</div>
  </div>

  <!-- Student Section -->
  <div id="student" class="section active">
    <h2>Student</h2>
    <button onclick="register()">Registrar Student</button>
    <button onclick="loginStudent()">Login Student</button>
    <button onclick="dashboard()">Dashboard</button>
    <button onclick="dbQuery()">Query Users</button>
    <button onclick="validate()">Validar Sessão</button>
    <button onclick="audit()">Registrar Auditoria</button>
    <button onclick="listVideos()">Listar Vídeos Oracle</button>
    <input type="file" id="uploadFileStudent">
    <button onclick="uploadFile('uploadFileStudent')">Upload Oracle</button>
  </div>

  <!-- Admin Section -->
  <div id="admin" class="section">
    <h2>Admin</h2>
    <button onclick="loginAdmin()">Login Admin</button>
    <button onclick="dashboard()">Dashboard</button>
    <button onclick="dbQuery()">Query Users</button>
    <button onclick="dbExecute()">Update User</button>
    <button onclick="validate()">Validar Sessão</button>
    <button onclick="audit()">Registrar Auditoria</button>
    <button onclick="listVideos()">Listar Vídeos Oracle</button>
    <input type="file" id="uploadFileAdmin">
    <button onclick="uploadFile('uploadFileAdmin')">Upload Oracle</button>
  </div>

  <h2>Saída</h2>
  <pre id="output">Clique em um botão para testar...</pre>

  <script>
    let token = null;

    function showTab(tabId) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');
      document.getElementById(tabId).classList.add('active');
    }

    function log(data) {
      document.getElementById('output').textContent = JSON.stringify(data, null, 2);
    }

    async function register() {
      const res = await fetch('/api/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: 'Student User', email: 'student@gmp.com', password: 'password123' })
      });
      log(await res.json());
    }

    async function loginStudent() {
      const res = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: 'student@gmp.com', password: 'password123' })
      });
      const data = await res.json();
      token = data.token;
      log(data);
    }

    async function loginAdmin() {
      const res = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: 'admin@gmp.com', password: 'admin123' })
      });
      const data = await res.json();
      token = data.token;
      log(data);
    }

    async function dashboard() {
      const res = await fetch('/api/dashboard', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      log(await res.json());
    }

    async function dbQuery() {
      const res = await fetch('/api/db/query', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify({ sql: 'SELECT id,email,name,role FROM users' })
      });
      log(await res.json());
    }

    async function dbExecute() {
      const res = await fetch('/api/db/execute', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify({ sql: 'UPDATE users SET name=? WHERE email=?', params: ['Novo Nome','student@gmp.com'] })
      });
      log(await res.json());
    }

    async function validate() {
      const res = await fetch('/api/security/validate', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      log(await res.json());
    }

    async function audit() {
      const res = await fetch('/api/security/audit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify({ action: 'TEST_ACTION' })
      });
      log(await res.json());
    }

    async function listVideos() {
      const res = await fetch('/api/oracle/videos', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      log(await res.json());
    }

    async function uploadFile(inputId) {
      const file = document.getElementById(inputId).files[0];
      if (!file) return alert('Selecione um arquivo');
      const formData = new FormData();
      formData.append('file', file);
      const res = await fetch('/api/oracle/upload', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token },
        body: formData
      });
      log(await res.json());
    }
  </script>
</body>
</html>
