<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMPé—¨æˆ·è‡ªåŠ¨æµ‹è¯•</title>
    <link rel="stylesheet" href="assets/css/gmp-portal.css">
    <style>
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .test-console {
            background: #1e1e1e;
            color: #fff;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .test-controls {
            text-align: center;
            margin-bottom: 20px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 16px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .test-summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            text-align: center;
        }
        .summary-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .summary-item h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .summary-item .value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .status-success { color: #28a745; }
        .status-error { color: #dc3545; }
        .status-warning { color: #ffc107; }
        .status-info { color: #17a2b8; }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            transition: width 0.3s ease;
        }
        .log-line {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-success { color: #28a745; }
        .log-error { color: #dc3545; }
        .log-warning { color: #ffc107; }
        .log-info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>GMPé—¨æˆ·è‡ªåŠ¨æµ‹è¯•ç³»ç»Ÿ</h1>
            <p>å…¨é¢çš„ç³»ç»ŸåŠŸèƒ½éªŒè¯å’Œæ€§èƒ½æµ‹è¯•</p>
        </div>

        <div class="test-controls">
            <button id="runTest" class="test-button">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <button id="clearConsole" class="test-button">æ¸…é™¤æ§åˆ¶å°</button>
            <button id="exportReport" class="test-button">å¯¼å‡ºæŠ¥å‘Š</button>
        </div>

        <div class="progress-bar">
            <div id="progressFill" class="progress-fill" style="width: 0%"></div>
        </div>

        <div class="test-summary">
            <div class="summary-grid">
                <div class="summary-item">
                    <h4>æ€»æµ‹è¯•æ•°</h4>
                    <div id="totalTests" class="value">0</div>
                </div>
                <div class="summary-item">
                    <h4>æˆåŠŸ</h4>
                    <div id="successTests" class="value status-success">0</div>
                </div>
                <div class="summary-item">
                    <h4>å¤±è´¥</h4>
                    <div id="errorTests" class="value status-error">0</div>
                </div>
                <div class="summary-item">
                    <h4>è­¦å‘Š</h4>
                    <div id="warningTests" class="value status-warning">0</div>
                </div>
                <div class="summary-item">
                    <h4>æˆåŠŸç‡</h4>
                    <div id="successRate" class="value">0%</div>
                </div>
                <div class="summary-item">
                    <h4>è€—æ—¶</h4>
                    <div id="testDuration" class="value">0ms</div>
                </div>
            </div>
        </div>

        <div id="testConsole" class="test-console">
            <div class="log-line log-info">ğŸš€ GMPé—¨æˆ·è‡ªåŠ¨æµ‹è¯•ç³»ç»Ÿå·²å‡†å¤‡å°±ç»ª</div>
            <div class="log-line log-info">ç‚¹å‡»"è¿è¡Œå®Œæ•´æµ‹è¯•"å¼€å§‹æµ‹è¯•...</div>
        </div>
    </div>

    <script src="assets/js/security.js"></script>
    <script src="assets/js/database.js"></script>
    <script src="quick-test.js"></script>
    <script>
        // æ§åˆ¶å°è¾“å‡ºé‡å®šå‘
        const originalLog = console.log;
        const consoleElement = document.getElementById('testConsole');
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            
            const message = args.join(' ');
            const logLine = document.createElement('div');
            logLine.className = 'log-line';
            
            // æ ¹æ®æ¶ˆæ¯å†…å®¹è®¾ç½®é¢œè‰²
            if (message.includes('[SUCCESS]')) {
                logLine.className += ' log-success';
            } else if (message.includes('[ERROR]')) {
                logLine.className += ' log-error';
            } else if (message.includes('[WARNING]')) {
                logLine.className += ' log-warning';
            } else if (message.includes('[INFO]')) {
                logLine.className += ' log-info';
            }
            
            logLine.textContent = message;
            consoleElement.appendChild(logLine);
            consoleElement.scrollTop = consoleElement.scrollHeight;
        };

        // æµ‹è¯•çŠ¶æ€ç®¡ç†
        let testRunner = null;
        let isTestRunning = false;

        // æ›´æ–°æµ‹è¯•ç»Ÿè®¡
        function updateTestStats(results) {
            const totalTests = results.length;
            const successTests = results.filter(r => r.status === 'success').length;
            const errorTests = results.filter(r => r.status === 'error').length;
            const warningTests = results.filter(r => r.status === 'warning').length;
            const successRate = totalTests > 0 ? Math.round((successTests / totalTests) * 100) : 0;
            
            document.getElementById('totalTests').textContent = totalTests;
            document.getElementById('successTests').textContent = successTests;
            document.getElementById('errorTests').textContent = errorTests;
            document.getElementById('warningTests').textContent = warningTests;
            document.getElementById('successRate').textContent = successRate + '%';
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(current, total) {
            const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
            document.getElementById('progressFill').style.width = percentage + '%';
        }

        // è¿è¡Œæµ‹è¯•
        async function runTest() {
            if (isTestRunning) return;
            
            isTestRunning = true;
            const runButton = document.getElementById('runTest');
            runButton.disabled = true;
            runButton.textContent = 'æµ‹è¯•è¿è¡Œä¸­...';
            
            // æ¸…ç©ºæ§åˆ¶å°
            consoleElement.innerHTML = '';
            
            // åˆ›å»ºæµ‹è¯•è¿è¡Œå™¨
            testRunner = new TestRunner();
            
            // ç›‘å¬æµ‹è¯•è¿›åº¦
            const originalLogResult = testRunner.log;
            let testCount = 0;
            const estimatedTests = 20; // é¢„ä¼°æµ‹è¯•æ•°é‡
            
            testRunner.log = function(test, status, message) {
                originalLogResult.call(this, test, status, message);
                testCount++;
                updateProgress(testCount, estimatedTests);
                updateTestStats(this.results);
            };
            
            // è®°å½•å¼€å§‹æ—¶é—´
            const startTime = Date.now();
            
            try {
                // è¿è¡Œæµ‹è¯•
                await testRunner.runAllTests();
                
                // æ›´æ–°æœ€ç»ˆç»Ÿè®¡
                updateTestStats(testRunner.results);
                
                // è®¡ç®—è€—æ—¶
                const duration = Date.now() - startTime;
                document.getElementById('testDuration').textContent = duration + 'ms';
                
                // æ›´æ–°è¿›åº¦åˆ°100%
                updateProgress(estimatedTests, estimatedTests);
                
                console.log('âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆ!');
                
            } catch (error) {
                console.log(`âŒ æµ‹è¯•è¿è¡Œå‡ºé”™: ${error.message}`);
            } finally {
                isTestRunning = false;
                runButton.disabled = false;
                runButton.textContent = 'è¿è¡Œå®Œæ•´æµ‹è¯•';
            }
        }

        // æ¸…é™¤æ§åˆ¶å°
        function clearConsole() {
            consoleElement.innerHTML = '';
            console.log('ğŸ§¹ æ§åˆ¶å°å·²æ¸…é™¤');
        }

        // å¯¼å‡ºæŠ¥å‘Š
        function exportReport() {
            if (!testRunner || !testRunner.results) {
                console.log('âš ï¸ æ²¡æœ‰æµ‹è¯•ç»“æœå¯å¯¼å‡ºï¼Œè¯·å…ˆè¿è¡Œæµ‹è¯•');
                return;
            }
            
            const report = {
                timestamp: new Date().toISOString(),
                duration: document.getElementById('testDuration').textContent,
                results: testRunner.results,
                summary: {
                    total: testRunner.results.length,
                    success: testRunner.results.filter(r => r.status === 'success').length,
                    error: testRunner.results.filter(r => r.status === 'error').length,
                    warning: testRunner.results.filter(r => r.status === 'warning').length,
                    info: testRunner.results.filter(r => r.status === 'info').length,
                    successRate: document.getElementById('successRate').textContent
                }
            };
            
            const reportBlob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const reportUrl = URL.createObjectURL(reportBlob);
            const reportLink = document.createElement('a');
            reportLink.href = reportUrl;
            reportLink.download = `gmp-portal-test-report-${new Date().toISOString().split('T')[0]}.json`;
            reportLink.click();
            
            console.log('ğŸ“„ æµ‹è¯•æŠ¥å‘Šå·²å¯¼å‡º');
        }

        // ç»‘å®šäº‹ä»¶
        document.getElementById('runTest').addEventListener('click', runTest);
        document.getElementById('clearConsole').addEventListener('click', clearConsole);
        document.getElementById('exportReport').addEventListener('click', exportReport);

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸŒŸ é¡µé¢åŠ è½½å®Œæˆï¼Œç³»ç»Ÿå·²å‡†å¤‡å°±ç»ª');
            console.log('ğŸ’¡ æç¤ºï¼šç‚¹å‡»"è¿è¡Œå®Œæ•´æµ‹è¯•"å¼€å§‹è‡ªåŠ¨åŒ–æµ‹è¯•');
        });
    </script>
</body>
</html>