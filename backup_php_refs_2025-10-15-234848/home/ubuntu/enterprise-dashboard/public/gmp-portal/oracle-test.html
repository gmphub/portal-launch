<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oracle集成TESTE - gmpPortalSistema</title>
    <link rel="stylesheet" href="assets/css/gmp-portal.css">
    <style>
        .oracle-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .config-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        .form-group input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button.success {
            background: #28a745;
        }
        .test-button.success:hover {
            background: #218838;
        }
        .results-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-connected { background: #28a745; }
        .status-disconnected { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .sync-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .sync-table th,
        .sync-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .sync-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="oracle-container">
        <h1>Oracle数据库集成TESTE</h1>
        
        <div class="test-section">
            <h2>Oracle连接配置</h2>
            <div class="config-form">
                <div class="form-group">
                    <label for="oracle-user">用户名:</label>
                    <input type="text" id="oracle-user" value="gmp_user" placeholder="Oracle用户名">
                </div>
                <div class="form-group">
                    <label for="oracle-password">密码:</label>
                    <input type="password" id="oracle-password" value="password123" placeholder="Oracle密码">
                </div>
                <div class="form-group">
                    <label for="oracle-host">主机:</label>
                    <input type="text" id="oracle-host" value="localhost" placeholder="Oracle主机">
                </div>
                <div class="form-group">
                    <label for="oracle-port">端口:</label>
                    <input type="text" id="oracle-port" value="1521" placeholder="Oracle端口">
                </div>
                <div class="form-group">
                    <label for="oracle-service">服务名:</label>
                    <input type="text" id="oracle-service" value="ORCL" placeholder="Oracle服务名">
                </div>
            </div>
            <button class="test-button" onclick="testOracleConnection()">TESTEOracle连接</button>
            <button class="test-button" onclick="saveOracleConfig()">保存配置</button>
            <div id="connection-status">
                <span class="status-indicator status-disconnected"></span>
                <span id="status-text">未连接</span>
            </div>
            <div id="connection-results" class="results-area"></div>
        </div>

        <div class="test-section">
            <h2>Oracle数据库操作TESTE</h2>
            <button class="test-button" onclick="testOracleQuery()">TESTEOracle查询</button>
            <button class="test-button" onclick="testOracleExecute()">TESTEOracle执行</button>
            <button class="test-button" onclick="testOracleProcedure()">TESTE存储过程</button>
            <button class="test-button" onclick="testOracleTransaction()">TESTEOracle事务</button>
            <div id="operation-results" class="results-area"></div>
        </div>

        <div class="test-section">
            <h2>数据同步TESTE</h2>
            <div class="sync-table">
                <thead>
                    <tr>
                        <th>表名</th>
                        <th>本地记录数</th>
                        <th>Oracle记录数</th>
                        <th>同步状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>USERS</td>
                        <td id="local-users-count">-</td>
                        <td id="oracle-users-count">-</td>
                        <td id="users-sync-status">未同步</td>
                        <td><button class="test-button" onclick="syncTable('users')">同步</button></td>
                    </tr>
                    <tr>
                        <td>PRODUCTS</td>
                        <td id="local-products-count">-</td>
                        <td id="oracle-products-count">-</td>
                        <td id="products-sync-status">未同步</td>
                        <td><button class="test-button" onclick="syncTable('products')">同步</button></td>
                    </tr>
                    <tr>
                        <td>ORDERS</td>
                        <td id="local-orders-count">-</td>
                        <td id="oracle-orders-count">-</td>
                        <td id="orders-sync-status">未同步</td>
                        <td><button class="test-button" onclick="syncTable('orders')">同步</button></td>
                    </tr>
                </tbody>
            </div>
            <button class="test-button success" onclick="syncAllTables()">同步所有表</button>
            <div class="progress-bar">
                <div id="sync-progress" class="progress-fill" style="width: 0%"></div>
            </div>
            <div id="sync-results" class="results-area"></div>
        </div>

        <div class="test-section">
            <h2>跨数据库查询TESTE</h2>
            <button class="test-button" onclick="testCrossDatabaseQuery()">TESTE跨数据库查询</button>
            <button class="test-button" onclick="testJoinQuery()">TESTE连接查询</button>
            <button class="test-button" onclick="testAggregateQuery()">TESTE聚合查询</button>
            <div id="cross-db-results" class="results-area"></div>
        </div>

        <div class="test-section">
            <h2>Oracle性能监控</h2>
            <button class="test-button" onclick="monitorOraclePerformance()">监控Oracle性能</button>
            <button class="test-button" onclick="analyzeQueryPerformance()">分析查询性能</button>
            <div id="performance-results" class="results-area"></div>
        </div>
    </div>

    <script src="assets/js/security.js"></script>
    <script src="assets/js/database.js"></script>
    <script>
        let oracleConfig = {
            user: 'gmp_user',
            password: 'password123',
            host: 'localhost',
            port: '1521',
            service: 'ORCL'
        };

        let testResults = {
            connection: [],
            operation: [],
            sync: [],
            crossDb: [],
            performance: []
        };

        function logResult(category, message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            testResults[category].push(logEntry);
            updateResults(category);
        }

        function updateResults(category) {
            const container = document.getElementById(category + '-results');
            if (container) {
                container.innerHTML = testResults[category].join('\n');
                container.scrollTop = container.scrollHeight;
            }
        }

        function updateConnectionStatus(connected, message) {
            const statusIndicator = document.querySelector('.status-indicator');
            const statusText = document.getElementById('status-text');
            
            statusIndicator.className = 'status-indicator ' + (connected ? 'status-connected' : 'status-disconnected');
            statusText.textContent = message;
        }

        function getOracleConfig() {
            return {
                user: document.getElementById('oracle-user').value,
                password: document.getElementById('oracle-password').value,
                connectString: `${document.getElementById('oracle-host').value}:${document.getElementById('oracle-port').value}/${document.getElementById('oracle-service').value}`
            };
        }

        async function testOracleConnection() {
            logResult('connection', '开始Oracle连接TESTE...');
            
            try {
                const config = getOracleConfig();
                const result = await gmp_Database.connectOracle(config);
                
                if (result.success) {
                    logResult('connection', `Oracle连接Sucesso: ${result.message}`, 'success');
                    logResult('connection', `Oracle版本: ${result.version}`, 'info');
                    logResult('connection', `连接ID: ${result.connectionId}`, 'info');
                    updateConnectionStatus(true, '已连接');
                } else {
                    logResult('connection', `Oracle连接Falha: ${result.error}`, 'error');
                    updateConnectionStatus(false, '连接Falha');
                }
            } catch (error) {
                logResult('connection', `Oracle连接异常: ${error.message}`, 'error');
                updateConnectionStatus(false, '连接异常');
            }
        }

        function saveOracleConfig() {
            oracleConfig = getOracleConfig();
            localStorage.setItem('oracle_config', JSON.stringify(oracleConfig));
            logResult('connection', 'Oracle配置已保存', 'success');
        }

        async function testOracleQuery() {
            logResult('operation', '开始Oracle查询TESTE...');
            
            try {
                // TESTE基本查询
                const result1 = await gmp_Database.oracleQuery('SELECT * FROM all_tables WHERE ROWNUM <= 5');
                logResult('operation', `表查询结果: ${result1.success ? 'Sucesso' : 'Falha'}`, result1.success ? 'success' : 'error');
                
                if (result1.success) {
                    logResult('operation', `找到 ${result1.rowCount} 个表`, 'info');
                    result1.data.forEach(table => {
                        logResult('operation', `- ${table.table_name} (owner: ${table.owner})`, 'info');
                    });
                }
                
                // TESTE用户查询
                const result2 = await gmp_Database.oracleQuery('SELECT user FROM dual');
                if (result2.success) {
                    logResult('operation', `当前用户: ${result2.data[0].user}`, 'info');
                }
                
            } catch (error) {
                logResult('operation', `Oracle查询异常: ${error.message}`, 'error');
            }
        }

        async function testOracleExecute() {
            logResult('operation', '开始Oracle执行TESTE...');
            
            try {
                // 创建TESTE表
                const createResult = await gmp_Database.execute(`
                    CREATE TABLE gmp_test_oracle (
                        id NUMBER PRIMARY KEY,
                        name VARCHAR2(100),
                        created_at DATE DEFAULT SYSDATE
                    )
                `);
                logResult('operation', `创建表结果: ${createResult.success ? 'Sucesso' : 'Falha'}`, createResult.success ? 'success' : 'error');
                
                if (createResult.success) {
                    // 插入TESTE数据
                    const insertResult = await gmp_Database.execute(`
                        INSERT INTO gmp_test_oracle (id, name) VALUES (1, 'Oracle Test')
                    `);
                    logResult('operation', `插入数据结果: ${insertResult.success ? 'Sucesso' : 'Falha'}`, insertResult.success ? 'success' : 'error');
                    
                    // 查询TESTE数据
                    const queryResult = await gmp_Database.oracleQuery('SELECT * FROM gmp_test_oracle');
                    if (queryResult.success) {
                        logResult('operation', `查询到 ${queryResult.rowCount} 条记录`, 'info');
                    }
                }
                
            } catch (error) {
                logResult('operation', `Oracle执行异常: ${error.message}`, 'error');
            }
        }

        async function testOracleProcedure() {
            logResult('operation', '开始Oracle存储过程TESTE...');
            
            try {
                // 创建存储过程
                const createProcResult = await gmp_Database.execute(`
                    CREATE OR REPLACE PROCEDURE gmp_test_proc(p_result OUT VARCHAR2) AS
                    BEGIN
                        p_result := 'Hello from Oracle procedure';
                    END;
                `);
                logResult('operation', `创建存储过程: ${createProcResult.success ? 'Sucesso' : 'Falha'}`, createProcResult.success ? 'success' : 'error');
                
                if (createProcResult.success) {
                    // 调用存储过程
                    const callResult = await gmp_Database.callProcedure('gmp_test_proc', []);
                    logResult('operation', `调用存储过程: ${callResult.success ? 'Sucesso' : 'Falha'}`, callResult.success ? 'success' : 'error');
                    
                    if (callResult.success) {
                        logResult('operation', `存储过程结果: ${callResult.result}`, 'info');
                    }
                }
                
            } catch (error) {
                logResult('operation', `存储过程TESTE异常: ${error.message}`, 'error');
            }
        }

        async function testOracleTransaction() {
            logResult('operation', '开始Oracle事务TESTE...');
            
            try {
                const result = await gmp_Database.transaction(async (db) => {
                    await db.execute('INSERT INTO gmp_test_oracle (id, name) VALUES (2, \'Transaction Test 1\')');
                    await db.execute('INSERT INTO gmp_test_oracle (id, name) VALUES (3, \'Transaction Test 2\')');
                    return 'Transaction completed successfully';
                });
                
                logResult('operation', `事务TESTE: ${result.success ? 'Sucesso' : 'Falha'}`, result.success ? 'success' : 'error');
                
                if (result.success) {
                    logResult('operation', `事务结果: ${result.result}`, 'info');
                }
                
            } catch (error) {
                logResult('operation', `事务TESTE异常: ${error.message}`, 'error');
            }
        }

        async function syncTable(tableName) {
            logResult('sync', `开始同步表: ${tableName}...`);
            
            try {
                const config = {
                    tables: [tableName],
                    syncMode: 'full'
                };
                
                const result = await gmp_Database.syncWithOracle(config);
                
                if (result.success) {
                    logResult('sync', `表 ${tableName} 同步Sucesso`, 'success');
                    logResult('sync', `同步记录数: ${result.totalRecords}`, 'info');
                    logResult('sync', `Duração: ${result.duration}`, 'info');
                    
                    // 更新同步状态
                    document.getElementById(`${tableName}-sync-status`).textContent = '已同步';
                    document.getElementById(`${tableName}-sync-status`).style.color = '#28a745';
                } else {
                    logResult('sync', `表 ${tableName} 同步Falha: ${result.error}`, 'error');
                }
                
            } catch (error) {
                logResult('sync', `表 ${tableName} 同步异常: ${error.message}`, 'error');
            }
        }

        async function syncAllTables() {
            logResult('sync', '开始同步所有表...');
            
            const tables = ['users', 'products', 'orders'];
            let completed = 0;
            
            for (const table of tables) {
                await syncTable(table);
                completed++;
                const progress = (completed / tables.length) * 100;
                document.getElementById('sync-progress').style.width = progress + '%';
            }
            
            logResult('sync', '所有表同步Concluído', 'success');
        }

        async function testCrossDatabaseQuery() {
            logResult('crossDb', '开始跨数据库查询TESTE...');
            
            try {
                // 模拟跨数据库查询
                const query = `
                    SELECT 
                        u.username,
                        u.email,
                        p.product_name,
                        o.order_date
                    FROM users u
                    LEFT JOIN products p ON u.user_id = p.user_id
                    LEFT JOIN orders o ON u.user_id = o.user_id
                    WHERE u.status = 'active'
                `;
                
                const result = await gmp_Database.oracleQuery(query);
                
                if (result.success) {
                    logResult('crossDb', `跨数据库查询Sucesso，返回 ${result.rowCount} 条记录`, 'success');
                    result.data.forEach((row, index) => {
                        logResult('crossDb', `记录 ${index + 1}: ${JSON.stringify(row)}`, 'info');
                    });
                } else {
                    logResult('crossDb', `跨数据库查询Falha: ${result.error}`, 'error');
                }
                
            } catch (error) {
                logResult('crossDb', `跨数据库查询异常: ${error.message}`, 'error');
            }
        }

        async function testJoinQuery() {
            logResult('crossDb', '开始连接查询TESTE...');
            
            try {
                const query = `
                    SELECT 
                        u.username,
                        COUNT(o.id) as order_count,
                        SUM(o.total) as total_spent
                    FROM users u
                    LEFT JOIN orders o ON u.id = o.user_id
                    GROUP BY u.username
                    ORDER BY total_spent DESC
                `;
                
                const result = await gmp_Database.oracleQuery(query);
                
                if (result.success) {
                    logResult('crossDb', `连接查询Sucesso，返回 ${result.rowCount} 条记录`, 'success');
                } else {
                    logResult('crossDb', `连接查询Falha: ${result.error}`, 'error');
                }
                
            } catch (error) {
                logResult('crossDb', `连接查询异常: ${error.message}`, 'error');
            }
        }

        async function testAggregateQuery() {
            logResult('crossDb', '开始聚合查询TESTE...');
            
            try {
                const query = `
                    SELECT 
                        COUNT(*) as total_users,
                        AVG(CASE WHEN status = 'active' THEN 1 ELSE 0 END) as active_rate,
                        MAX(created_at) as latest_user
                    FROM users
                `;
                
                const result = await gmp_Database.oracleQuery(query);
                
                if (result.success) {
                    logResult('crossDb', `聚合查询Sucesso`, 'success');
                    result.data.forEach(row => {
                        logResult('crossDb', `总用户数: ${row.total_users}`, 'info');
                        logResult('crossDb', `活跃率: ${row.active_rate}`, 'info');
                        logResult('crossDb', `最新用户: ${row.latest_user}`, 'info');
                    });
                } else {
                    logResult('crossDb', `聚合查询Falha: ${result.error}`, 'error');
                }
                
            } catch (error) {
                logResult('crossDb', `聚合查询异常: ${error.message}`, 'error');
            }
        }

        async function monitorOraclePerformance() {
            logResult('performance', '开始Oracle性能监控...');
            
            try {
                // 模拟性能监控查询
                const queries = [
                    'SELECT COUNT(*) FROM v$session',
                    'SELECT table_name, num_rows FROM all_tables WHERE owner = USER',
                    'SELECT * FROM v$sysstat WHERE rownum <= 10'
                ];
                
                for (const query of queries) {
                    const result = await gmp_Database.oracleQuery(query);
                    logResult('performance', `性能查询执行: ${result.success ? 'Sucesso' : 'Falha'}`, result.success ? 'success' : 'error');
                }
                
                logResult('performance', 'Oracle性能监控Concluído', 'success');
                
            } catch (error) {
                logResult('performance', `性能监控异常: ${error.message}`, 'error');
            }
        }

        async function analyzeQueryPerformance() {
            logResult('performance', '开始查询性能分析...');
            
            try {
                const startTime = performance.now();
                
                // 执行TESTE查询
                const result = await gmp_Database.oracleQuery('SELECT * FROM all_tables WHERE rownum <= 100');
                
                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);
                
                logResult('performance', `查询执行时间: ${duration}ms`, 'info');
                logResult('performance', `返回记录数: ${result.rowCount}`, 'info');
                logResult('performance', `平均每条记录Duração: ${(duration / result.rowCount).toFixed(2)}ms`, 'info');
                
            } catch (error) {
                logResult('performance', `查询性能分析异常: ${error.message}`, 'error');
            }
        }

        // 页面加载时的初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 加载保存的配置
            const savedConfig = localStorage.getItem('oracle_config');
            if (savedConfig) {
                oracleConfig = JSON.parse(savedConfig);
                document.getElementById('oracle-user').value = oracleConfig.user;
                document.getElementById('oracle-password').value = oracleConfig.password;
                document.getElementById('oracle-host').value = oracleConfig.host;
                document.getElementById('oracle-port').value = oracleConfig.port;
                document.getElementById('oracle-service').value = oracleConfig.service;
            }
            
            logResult('connection', 'Oracle集成TESTE页面Página carregada');
            logResult('operation', 'Oracle操作TESTEPronto');
            logResult('sync', '数据同步TESTEPronto');
            logResult('crossDb', '跨数据库查询TESTEPronto');
            logResult('performance', '性能监控TESTEPronto');
        });
    </script>
<

<script src="assets/js/admin-tabs.js"></script>
<

<script src="assets/js/admin-dropdown.js"></script>
<
/body>
</html>